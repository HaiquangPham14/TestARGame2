<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
        #camera-button-container {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        
        #camera-button {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #ffffff;
            box-shadow: 0 0 0 4px #ff3250;
            cursor: pointer;
            outline: none;
            transition: all 0.2s ease;
            position: relative;
        }
        
        #status-text {
            color: white;
            font-size: 14px;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 12px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body>
    <!-- Loading screen -->
    <div id="loading-screen"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: black; color: white; display: flex; justify-content: center; align-items: center; z-index: 9999;">
        <h1>Đang tải nội dung...</h1>
    </div>

    <a-scene mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/targets2.mind;"
        color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false">
        <a-assets>
            <video id="video0" src="https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/Sapporo1.mp4" preload="auto"
                crossorigin="anonymous" webkit-playsinline playsinline loop></video>
            <video id="video1" src="https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/Sapporo2.mp4" preload="auto"
                crossorigin="anonymous" webkit-playsinline playsinline loop></video>
            <video id="video2" src="https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/Sapporo3.mp4" preload="auto"
                crossorigin="anonymous" webkit-playsinline playsinline loop></video>
            <video id="video3" src="https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/Sapporo4.mp4" preload="auto"
                crossorigin="anonymous" webkit-playsinline playsinline loop></video>
            <video id="video4" src="https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/Sapporo5.mp4" preload="auto"
                crossorigin="anonymous" webkit-playsinline playsinline loop></video>
            <video id="video5" src="https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/Sapporo6.mp4" preload="auto"
                crossorigin="anonymous" webkit-playsinline playsinline loop></video>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0">
            <a-video src="#video0" width="1" height="0.5625" position="0 -0.25 0"></a-video>
        </a-entity>
        <a-entity mindar-image-target="targetIndex: 1">
            <a-video src="#video1" width="1" height="0.5625" position="0 -0.25 0"></a-video>
        </a-entity>
        <a-entity mindar-image-target="targetIndex: 2">
            <a-video src="#video2" width="1" height="0.5625" position="0 -0.25 0"></a-video>
        </a-entity>
        <a-entity mindar-image-target="targetIndex: 3">
            <a-video src="#video3" width="1" height="0.5625" position="0 -0.25 0"></a-video>
        </a-entity>
        <a-entity mindar-image-target="targetIndex: 4">
            <a-video src="#video4" width="1" height="0.5625" position="0 -0.25 0"></a-video>
        </a-entity>
        <a-entity mindar-image-target="targetIndex: 5">
            <a-video src="#video5" width="1" height="0.5625" position="0 -0.25 0"></a-video>
        </a-entity>
    </a-scene>

    <video id="real-camera-video" autoplay playsinline style="display: none;"></video>
    <canvas id="screenshot-canvas" style="display: none;"></canvas>

    <div id="camera-button-container">
        <button id="camera-button"></button>
        <div id="status-text">Nhấn để chụp, giữ để quay video</div>
    </div>

    <script>
        let isRecording = false;
        let mediaRecorder;
        let recordedChunks = [];
        let pressTimer;

        window.addEventListener("DOMContentLoaded", async () => {
            const loadingScreen = document.getElementById("loading-screen");

            // Danh sách video IDs
            const videoIds = ["video0", "video1", "video2", "video3", "video4", "video5"];
            const videos = videoIds.map(id => document.getElementById(id));
            let videosReady = 0;

            const onVideoReady = () => {
                videosReady++;
                if (videosReady === videos.length) {
                    loadingScreen.style.display = "none";
                    videos.forEach(video => video.muted = false);
                }
            };

            // Load từng video và gắn listener
            videos.forEach(video => {
                video.load();
                video.addEventListener('canplaythrough', onVideoReady);
            });

            // Khởi tạo camera
            await initializeRealCamera();

            // Thiết lập nút camera
            setupCameraButton();

            // Thiết lập sự kiện cho các target
            for (let i = 0; i < 6; i++) {
                const targetSelector = `a-entity[mindar-image-target="targetIndex: ${i}"]`;
                const target = document.querySelector(targetSelector);
                const video = document.getElementById(`video${i}`);

                target.addEventListener('targetFound', () => {
                    video.muted = false;
                    video.currentTime = 0;
                    video.play();
                });
                target.addEventListener('targetLost', () => {
                    video.pause();
                    video.currentTime = 0;
                });
            }
        });

        async function initializeRealCamera() {
            const video = document.getElementById("real-camera-video");
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment" },
                    audio: false
                });
                video.srcObject = stream;
                await video.play();
            } catch (error) {
                console.error("Lỗi khi truy cập camera:", error);
            }
        }

        function setupCameraButton() {
            const cameraButton = document.getElementById('camera-button');
            cameraButton.addEventListener('touchstart', startPress);
            cameraButton.addEventListener('mousedown', startPress);
            cameraButton.addEventListener('touchend', endPress);
            cameraButton.addEventListener('mouseup', endPress);
            cameraButton.addEventListener('mouseleave', cancelPress);
        }

        function startPress(e) {
            e.preventDefault();
            if (pressTimer) clearTimeout(pressTimer);
            pressTimer = setTimeout(() => startRecording(), 500); // Giữ 500ms để quay
        }

        function endPress(e) {
            e.preventDefault();
            if (pressTimer) {
                clearTimeout(pressTimer);
                capturePhoto();
            } else if (isRecording) {
                stopRecording();
            }
        }

        function cancelPress() {
            if (pressTimer) clearTimeout(pressTimer);
        }

        // Helper function to get AR canvas (WebGL) as image
        function getARCanvasImageData(callback) {
            // MindAR renders to a-scene's renderer.domElement
            const scene = document.querySelector('a-scene');
            // Wait for renderer and canvas to be available
            if (!scene || !scene.renderer || !scene.renderer.domElement) {
                setTimeout(() => getARCanvasImageData(callback), 100);
                return;
            }
            const arCanvas = scene.renderer.domElement;
            callback(arCanvas);
        }

        function capturePhoto() {
            getARCanvasImageData((arCanvas) => {
                const screenshotCanvas = document.getElementById("screenshot-canvas");
                screenshotCanvas.width = arCanvas.width;
                screenshotCanvas.height = arCanvas.height;
                const ctx = screenshotCanvas.getContext("2d");
                // Draw AR canvas directly (contains both real camera and AR video overlays)
                ctx.drawImage(arCanvas, 0, 0, screenshotCanvas.width, screenshotCanvas.height);

                const link = document.createElement("a");
                link.download = `sapporo-ar-${Date.now()}.png`;
                link.href = screenshotCanvas.toDataURL("image/png");
                link.click();
            });
        }

        function startRecording() {
            getARCanvasImageData((arCanvas) => {
                const combinedCanvas = document.createElement("canvas");
                combinedCanvas.width = arCanvas.width;
                combinedCanvas.height = arCanvas.height;
                const ctx = combinedCanvas.getContext("2d");

                // Use AR canvas as the source (contains both camera and AR video)
                const stream = combinedCanvas.captureStream(30);
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/mp4' });
                mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/mp4' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = `record-${Date.now()}.mp4`;
                    a.click();
                    URL.revokeObjectURL(url);
                    recordedChunks = [];
                };

                function drawFrame() {
                    if (!isRecording) return;
                    ctx.drawImage(arCanvas, 0, 0, combinedCanvas.width, combinedCanvas.height);
                    requestAnimationFrame(drawFrame);
                }

                mediaRecorder.start();
                isRecording = true;
                drawFrame();
            });
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
            }
        }
    </script>
</body>
</html>