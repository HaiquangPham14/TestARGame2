<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
      }
      #controls {
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10;
        display: flex;
        gap: 12px;
      }
      #controls button {
        padding: 10px 15px;
        font-size: 16px;
        border-radius: 5px;
        border: none;
        background-color: #4caf50;
        color: white;
        cursor: pointer;
      }
      #stop-button {
        background-color: #f44336;
      }
      #photo-preview img {
        max-width: 100px;
        margin-top: 8px;
      }
    </style>
  </head>
  <body>
    <a-scene
      mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/targets.mind"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <a-assets>
        <video
          id="video1"
          src="https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/Sapporo1.mp4"
          preload="auto"
          crossorigin="anonymous"
          webkit-playsinline
          playsinline
        ></video>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity id="target" mindar-image-target="targetIndex: 0">
        <a-video
          id="video-plane"
          src="#video1"
          width="1"
          height="0.5625"
          position="0 0 0"
          rotation="0 0 0"
        ></a-video>
      </a-entity>
    </a-scene>

    <div id="controls">
      <button id="capture-button">Chụp ảnh</button>
      <button id="record-button">Bắt đầu quay</button>
      <button id="stop-button" style="display: none">Dừng quay</button>
      <div id="photo-preview"></div>
    </div>

    <script>
      // === PRELOAD VIDEO NGAY KHI VÀO TRANG ===
      document.addEventListener("DOMContentLoaded", () => {
        const video = document.getElementById("video1");
        // Gọi load() để chắc chắn video được fetch về
        video.load();
        // Trick: play-pause để buộc preload
        video.muted = true;
        video.play().then(() => {
          video.pause();
          video.currentTime = 0;
          video.muted = false;
        }).catch(() => {
          // Trình duyệt chặn autoplay, không sao cả
        });

        // Khi nhận diện marker thì chỉ cần video.play() và hiện ra ngay
        const target = document.querySelector("#target");
        target.addEventListener("targetFound", () => {
          video.play();
        });
        target.addEventListener("targetLost", () => {
          video.pause();
          video.currentTime = 0;
        });
        video.addEventListener("error", () => {
          document.body.addEventListener(
            "click",
            () => {
              video.play();
            },
            { once: true }
          );
        });

        // ==== QUAY VIDEO + ÂM THANH (camera+AR+video+mic) & CHỤP ẢNH ====

        // Lấy canvas của A-Frame
        function getARCanvas() {
          return document.querySelector("canvas.a-canvas");
        }

        // Tạo video element để stream camera
        const cameraVideo = document.createElement("video");
        cameraVideo.style.display = "none";
        document.body.appendChild(cameraVideo);

        // Lấy stream camera
        async function getCameraStream() {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({
              video: { facingMode: "environment" }, // Camera phía sau
            });
            cameraVideo.srcObject = stream;
            cameraVideo.play();
            return stream;
          } catch (err) {
            alert("Không thể truy cập camera: " + err.message);
            throw err;
          }
        }

        // Tạo canvas tổng hợp (camera + AR)
        function createCompositeCanvas() {
          const arCanvas = getARCanvas();
          if (!arCanvas) {
            throw new Error("Không tìm thấy canvas của AR!");
          }

          const compositeCanvas = document.createElement("canvas");
          compositeCanvas.width = arCanvas.width;
          compositeCanvas.height = arCanvas.height;
          const ctx = compositeCanvas.getContext("2d");

          // Hàm vẽ frame
          function drawFrame() {
            // Vẽ stream camera làm nền
            if (cameraVideo.readyState === cameraVideo.HAVE_ENOUGH_DATA) {
              ctx.drawImage(cameraVideo, 0, 0, compositeCanvas.width, compositeCanvas.height);
            }

            // Vẽ nội dung AR lên trên
            ctx.drawImage(arCanvas, 0, 0, compositeCanvas.width, compositeCanvas.height);

            requestAnimationFrame(drawFrame);
          }

          drawFrame();
          return compositeCanvas;
        }

        // Khởi tạo camera ngay khi load trang
        getCameraStream();

        // Chụp ảnh
        document.getElementById("capture-button").onclick = function () {
          const arCanvas = getARCanvas();
          if (!arCanvas) {
            alert("Không tìm thấy canvas của AR!");
            return;
          }

          // Tạo canvas tạm để chụp ảnh (camera + AR)
          const tempCanvas = document.createElement("canvas");
          tempCanvas.width = arCanvas.width;
          tempCanvas.height = arCanvas.height;
          const ctx = tempCanvas.getContext("2d");

          // Vẽ camera làm nền
          if (cameraVideo.readyState === cameraVideo.HAVE_ENOUGH_DATA) {
            ctx.drawImage(cameraVideo, 0, 0, tempCanvas.width, tempCanvas.height);
          }

          // Vẽ AR lên trên
          ctx.drawImage(arCanvas, 0, 0, tempCanvas.width, tempCanvas.height);

          // Hiển thị preview
          const img = document.createElement("img");
          img.src = tempCanvas.toDataURL("image/png");
          const preview = document.getElementById("photo-preview");
          preview.innerHTML = "";
          preview.appendChild(img);

          // Tải ảnh về máy
          const link = document.createElement("a");
          link.download = `screenshot-${Date.now()}.png`;
          link.href = img.src;
          link.click();
        };

        // Quay video: hình từ camera + AR, tiếng từ video1 + micro
        let mediaRecorder, recordedChunks = [];
        let audioCtx, dest;

        document.getElementById("record-button").onclick = async function () {
          try {
            // Tạo canvas tổng hợp
            const compositeCanvas = createCompositeCanvas();
            const canvasStream = compositeCanvas.captureStream(30);

            // Khởi tạo audio context
            const videoElem = document.getElementById("video1");
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            dest = audioCtx.createMediaStreamDestination();

            // Audio từ video
            const videoSource = audioCtx.createMediaElementSource(videoElem);
            videoSource.connect(dest);
            videoSource.connect(audioCtx.destination);

            // Audio từ micro
            try {
              const micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
              const micSource = audioCtx.createMediaStreamSource(micStream);
              micSource.connect(dest);
            } catch (err) {
              alert("Không thể truy cập micro: " + err.message);
            }

            // Thêm audio track vào stream
            dest.stream.getAudioTracks().forEach((track) => {
              canvasStream.addTrack(track);
            });

            // Cấu hình MediaRecorder
            let mimeTypeOptions = [
              "video/mp4;codecs=h264,mp4a.40.2", // MP4 with H.264 and AAC
              "video/mp4",
              "video/mp4;codecs=vp8,opus", // mp4 fallback
              "video/mp4",
            ];

            let selectedMimeType = null;
            for (let mimeType of mimeTypeOptions) {
              if (MediaRecorder.isTypeSupported(mimeType)) {
                selectedMimeType = mimeType;
                break;
              }
            }

            if (!selectedMimeType) {
              alert("Trình duyệt không hỗ trợ định dạng ghi video phù hợp.");
              return;
            }

            mediaRecorder = new MediaRecorder(canvasStream, { mimeType: selectedMimeType });
            mediaRecorder.ondataavailable = function (event) {
              if (event.data.size > 0) recordedChunks.push(event.data);
            };
            mediaRecorder.onstop = function () {
              const isMp4 = selectedMimeType.includes("mp4");
              const blob = new Blob(recordedChunks, { type: selectedMimeType });
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;
              a.download = `recording-${Date.now()}.${isMp4 ? "mp4" : "mp4"}`;
              a.click();
            };
            mediaRecorder.start();
            document.getElementById("record-button").style.display = "none";
            document.getElementById("stop-button").style.display = "";
          } catch (err) {
            alert("Lỗi khi quay video: " + err.message);
          }
        };

        document.getElementById("stop-button").onclick = function () {
          if (mediaRecorder && mediaRecorder.state !== "inactive") {
            mediaRecorder.stop();
          }
          document.getElementById("stop-button").style.display = "none";
          document.getElementById("record-button").style.display = "";
        };

        // Resume AudioContext on user interaction (Safari requirement)
        document.addEventListener(
          "touchstart",
          function () {
            if (audioCtx && audioCtx.state === "suspended") {
              audioCtx.resume().then(() => {
                console.log("AudioContext resumed on user interaction");
              });
            }
          },
          { once: true }
        );
      });
    </script>
  </body>
</html>