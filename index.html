<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
      #controls {
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10;
        display: flex;
        gap: 12px;
      }
      #loader {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        background: rgba(0, 0, 0, 0.7);
        padding: 15px;
        border-radius: 5px;
        z-index: 1000;
      }
      #real-camera-video {
        display: none;
      }
    </style>
</head>
<body>
    <div id="loader">Đang tải ứng dụng...</div>

    <a-scene
      mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/targets.mind"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <a-assets>
        <video
          id="video1"
          src="https://cdn.jsdelivr.net/gh/HaiquangPham14/TestARGame2@main/Sapporo1.mp4"
          preload="metadata"
          crossorigin="anonymous"
          webkit-playsinline
          playsinline
        ></video>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity id="target" mindar-image-target="targetIndex: 0">
        <a-video
          id="video-plane"
          src="#video1"
          width="1"
          height="0.5625"
          position="0 0 0"
          rotation="0 0 0"
        ></a-video>
      </a-entity>
    </a-scene>

    <video id="real-camera-video" autoplay playsinline></video>

    <div id="controls">
      <button id="capture-button">Chụp ảnh</button>
      <button id="record-button">Bắt đầu quay</button>
      <button id="stop-button" style="display: none">Dừng quay</button>
    </div>

    <script>
      // === BIẾN TOÀN CỤC ===
      let mediaRecorder, recordedChunks = [];
      let audioCtx, dest;
      let realCameraStream;
      let isUserInteracted = false;

      // === KHỞI TẠO CAMERA PHÍA SAU ===
      async function initializeRealCamera() {
        try {
          const video = document.getElementById("real-camera-video");
          realCameraStream = await navigator.mediaDevices.getUserMedia({
            video: {
              facingMode: "environment",
              width: { ideal: 1280 },
              height: { ideal: 720 },
            },
          });
          video.srcObject = realCameraStream;
          await video.play();
        } catch (error) {
          alert("Không thể truy cập camera phía sau: " + error.message);
        }
      }

      // === XỬ LÝ VIDEO AR ===
      async function setupARVideo() {
        const video = document.getElementById("video1");
        const target = document.querySelector("#target");

        // Tải video trước
        video.load();

        // Xử lý autoplay
        const tryPlay = async () => {
          try {
            await video.play();
            document.getElementById("loader").style.display = "none";
          } catch (err) {
            if (!isUserInteracted) {
              document.getElementById("loader").innerHTML = "Chạm vào màn hình để bắt đầu";
            }
          }
        };

        // Sự kiện tương tác người dùng
        document.body.addEventListener("click", async () => {
          if (!isUserInteracted) {
            isUserInteracted = true;
            await tryPlay();
          }
        });

        target.addEventListener("targetFound", async () => {
          // Chỉ phát video khi mã đã được quét
          await video.play();
        });

        target.addEventListener("targetLost", () => {
          video.pause();
          video.currentTime = 0;
        });

        // Thử phát video lần đầu
        await tryPlay();
      }

      // === CHỨC NĂNG CHỤP ẢNH ===
      function getARCanvas() {
        return document.querySelector("canvas.a-canvas");
      }

      document.getElementById("capture-button").onclick = function () {
        const arCanvas = getARCanvas();
        const realCameraVideo = document.getElementById("real-camera-video");

        if (!arCanvas || !realCameraVideo) {
          alert("Không tìm thấy canvas hoặc video camera!");
          return;
        }

        // Đợi một frame để đảm bảo dữ liệu đã sẵn sàng
        requestAnimationFrame(() => {
          // Tạo canvas tạm để chụp ảnh
          const tempCanvas = document.createElement("canvas");
          tempCanvas.width = arCanvas.width;
          tempCanvas.height = arCanvas.height;
          const ctx = tempCanvas.getContext("2d");

          // Vẽ video camera làm nền
          if (realCameraVideo.readyState >= realCameraVideo.HAVE_CURRENT_DATA) {
            ctx.drawImage(realCameraVideo, 0, 0, tempCanvas.width, tempCanvas.height);
          } else {
            console.warn("Camera video not ready, using black background");
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
          }

          // Vẽ nội dung AR lên trên
          ctx.drawImage(arCanvas, 0, 0, tempCanvas.width, tempCanvas.height);

          // Tạo và tải ảnh
          const img = document.createElement("img");
          img.src = tempCanvas.toDataURL("image/png");
          const link = document.createElement("a");
          link.download = `screenshot-${Date.now()}.png`;
          link.href = img.src;
          link.click();

          // (Tùy chọn) Hiển thị preview (bỏ nếu không cần)
          // const preview = document.getElementById("photo-preview");
          // preview.innerHTML = "";
          // preview.appendChild(img);
        });
      };

      // === CHỨC NĂNG QUAY VIDEO ===
      document.getElementById("record-button").onclick = async function () {
        try {
          recordedChunks = [];
          const arCanvas = document.querySelector("canvas.a-canvas");
          const realCameraVideo = document.getElementById("real-camera-video");
          const arVideo = document.getElementById("video1");

          // Tạo canvas tổng hợp
          const combinedCanvas = document.createElement("canvas");
          combinedCanvas.width = arCanvas.width;
          combinedCanvas.height = arCanvas.height;
          const ctx = combinedCanvas.getContext("2d");

          // Tạo stream từ canvas tổng hợp
          const stream = combinedCanvas.captureStream(30);

          // Xử lý âm thanh
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          dest = audioCtx.createMediaStreamDestination();

          // Kết nối âm thanh video AR
          const videoSource = audioCtx.createMediaElementSource(arVideo);
          videoSource.connect(audioCtx.destination); // Phát ra loa
          videoSource.connect(dest); // Gửi đến bản ghi

          // Âm thanh microphone
          const micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          const micSource = audioCtx.createMediaStreamSource(micStream);
          micSource.connect(dest);

          // Kết hợp audio
          dest.stream.getAudioTracks().forEach((track) => stream.addTrack(track));

          // Vẽ khung hình
          function drawFrame() {
            if (!realCameraVideo.paused) {
              ctx.drawImage(realCameraVideo, 0, 0, combinedCanvas.width, combinedCanvas.height);
              ctx.drawImage(arCanvas, 0, 0, combinedCanvas.width, combinedCanvas.height);
            }
            requestAnimationFrame(drawFrame);
          }
          drawFrame();

          // Thiết lập recorder
          mediaRecorder = new MediaRecorder(stream, {
            mimeType: "video/mp4",
            videoBitsPerSecond: 2500000,
            audioBitsPerSecond: 128000,
          });

          mediaRecorder.ondataavailable = (e) => recordedChunks.push(e.data);
          mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: "video/mp4" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `recording-${Date.now()}.mp4`;
            a.click();
          };

          mediaRecorder.start();
          document.getElementById("record-button").style.display = "none";
          document.getElementById("stop-button").style.display = "";
        } catch (error) {
          alert("Lỗi khi quay video: " + error.message);
        }
      };

      // === DỪNG QUAY ===
      document.getElementById("stop-button").onclick = function () {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
          mediaRecorder.stop();
        }
        document.getElementById("stop-button").style.display = "none";
        document.getElementById("record-button").style.display = "";
      };

      // === KHỞI TẠO ỨNG DỤNG ===
      document.addEventListener("DOMContentLoaded", async () => {
        await initializeRealCamera();
        await setupARVideo();
      });
    </script>
</body>
</html>