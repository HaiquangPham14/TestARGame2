<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>mind-ar.js + video trigger + record</title>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.7/dist/mindar-image.prod.js"></script>
  <style>
    #mindar-container { position: relative; width: 640px; height: 480px; }
    #ar-video { position: absolute; top:0; left:0; z-index:2; width:640px; height:480px; display:none; }
    #canvas { position: absolute; top:0; left:0; z-index:1; }
    #controls { margin-top: 10px; }
  </style>
</head>
<body>
  <div id="mindar-container">
    <video id="ar-video" crossorigin="anonymous"></video>
    <canvas id="canvas" width="640" height="480"></canvas>
  </div>
  <div id="controls">
    <button id="capture-button">Chụp ảnh</button>
    <button id="record-button">Bắt đầu quay</button>
    <button id="stop-button" style="display:none;">Dừng quay</button>
    <div id="photo-preview"></div>
  </div>
  <script>
    const VIDEO_URL = "https://pub-a2cc4cd01cd142d9b13f2e0346176e83.r2.dev/Sapporo%20Premium%20Beer%20-%203-STEP%20POURING%2C%20THE%20EXCELLENCY%20OF%20SMOOTHNESS.mp4";
    const MIND_FILE = "targets.mind"; 

    const arVideo = document.getElementById('ar-video');
    arVideo.src = VIDEO_URL;

    // Mở camera
    async function openCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        arVideo.srcObject = stream;
      } catch (error) {
        console.error("Error accessing the camera:", error);
        alert("Không thể truy cập camera. Vui lòng kiểm tra quyền truy cập.");
      }
    }

    // mind-ar.js setup
    const mindar = new window.MINDAR.IMAGE.MindARThree({
      container: document.querySelector("#mindar-container"),
      imageTargetSrc: MIND_FILE,
      maxTrack: 1,
      uiScanning: false,
      uiLoading: "no",
    });

    const {renderer, scene, camera} = mindar;
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    let detected = false;

    mindar.on("targetFound", () => {
      detected = true;
      arVideo.currentTime = 0;
      arVideo.style.display = "block";
      arVideo.play();
    });
    mindar.on("targetLost", () => {
      detected = false;
      arVideo.pause();
      arVideo.style.display = "none";
    });

    async function renderLoop() {
      renderer.render(scene, camera);
      ctx.drawImage(renderer.domElement, 0, 0, canvas.width, canvas.height);
      requestAnimationFrame(renderLoop);
    }

    openCamera().then(() => {
      mindar.start().then(() => {
        renderLoop();
      });
    });

    // Chụp ảnh
    document.getElementById('capture-button').onclick = function () {
      const img = document.createElement('img');
      img.src = canvas.toDataURL('image/png');
      document.getElementById('photo-preview').innerHTML = '';
      document.getElementById('photo-preview').appendChild(img);
    };

    // Quay video canvas + tiếng video
    let mediaRecorder, recordedChunks = [];
    document.getElementById('record-button').onclick = async function () {
      recordedChunks = [];
      const canvasStream = canvas.captureStream(30);

      // Lấy audio từ video
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const dest = audioCtx.createMediaStreamDestination();
      const source = audioCtx.createMediaElementSource(arVideo);
      source.connect(dest);
      source.connect(audioCtx.destination);

      dest.stream.getAudioTracks().forEach(track => canvasStream.addTrack(track));
      mediaRecorder = new MediaRecorder(canvasStream, { mimeType: 'video/webm' });

      mediaRecorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'ar-record.webm';
        a.click();
      };

      mediaRecorder.start();
      document.getElementById('record-button').style.display = 'none';
      document.getElementById('stop-button').style.display = '';
    };

    document.getElementById('stop-button').onclick = function () {
      mediaRecorder.stop();
      document.getElementById('stop-button').style.display = 'none';
      document.getElementById('record-button').style.display = '';
    };
  </script>
</body>
</html>